---
title: "技术架构"
slug: "技术架构"
hidden: false
createdAt: "2018-12-14T09:14:13.424Z"
updatedAt: "2018-12-29T12:05:31.965Z"
---
[block:api-header]
{
  "title": "集成链交互游戏运行环境"
}
[/block]

[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/98ad35a-222.png",
        "222.png",
        490,
        259,
        "#b9c2ce"
      ],
      "caption": "Cocos-BCX链上游戏、应用的运行环境架构"
    }
  ]
}
[/block]
**多平台游戏集成运行环境**

Cocos-BCX 认为未来的区块链游戏的运行环境应具备以下的特征：
  * 一致和完善的链互操作接口；
  * 向下透明的承接方式；
  * 封装的原子操作；
  * 多平台兼容。

为了简化开发者的使用过程，Cocos-BCX设计了一套可适配多种类型 APP 的集成运行环境，以及配套的互操作接口。和COCOS Creator结合，简化游戏程序和区块链的对接过程，使链内交互工作对开发者透明化，让传统游戏的开发者也能无门槛地开发或迁移区块链游戏。

Cocos-BCX 链上游戏运行 SDK被集成到 Cocos 引擎 Runtime 中，对游戏提供完整的链交互接口，游戏开发者基于 Cocos-BCX SDK完成游戏内容向区块链网络的接入，链交互过程透明化、结构化，游戏开发团队不再需要投入研发力量用于适配链网络和不同设备。

同时，运行环境将兼容原生 Android、iOS 和 PC Web、移动H5等系统和环境。运行环境内的游戏将具备原生的跨平台能力，实现链上游戏在多个平台无障碍运行的特性。

[block:api-header]
{
  "title": "区块链交互接口"
}
[/block]
Cocos-BCX 提供链交互的开发环境，以便开发者能够通过这套环境便捷地与链交互。

Cocos-BCX 的区块链交互开发环境提供兼容多种工作平台的开发组件，包括适配 Android、iOS系统的SDK，适配前端 web 应用的 javascript 库，以及适配后端应用的 python、PHP库等。

开发者能够使用这些开发环境开发自己的区块链软件，实现数据交互，诸如用户注册、用户信息和资产操作、用户游戏数据操作等功能。链上数据接口允许用户在链上存储同质或非同质资产数据，并且为了提供最佳的兼容性和可定制特性，区块链系统不会强制要求资产数据以明文方式存储，游戏开发者可以更灵活的设计自己的链上数据存储结构，以便这些信息可以更为安全地通过游戏客户端和市场的插件解析。

目前链交互开发环境主要提供同质、非同质数字资产和道具查询、转移、所有权变更、事务提交、提议与表决等功能的封装。

[block:api-header]
{
  "title": "多链铆接承兑网关"
}
[/block]
Cocos-BCX 中，同质、非同质资产和智能合约是分离的。可以预见的，Cocos-BCX 的网络中会存在大量的、持续发生的事务，需要尽可能降低资产解析和流转的运算成本，更容易实现非同质资产的跨链映射，并且“资产和合约分离”是更安全的设计。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/2bb6320-123.png",
        "123.png",
        397,
        261,
        "#f7f8f9"
      ],
      "caption": "承兑网关"
    }
  ]
}
[/block]
Cocos-BCX 提供一套映射网关用于游戏金币和道具的自动化承兑，在统一的价值衡量体系下，实现链上不同游戏、不同平台间内容的平滑过度，可用于承兑的内容包括游戏金币、游戏装备数据等。
[block:api-header]
{
  "title": "区块链系统的优化和扩展"
}
[/block]
**改进非同质资产数据结构**

非同质数字资产是一种应用于分布式记账网络中的数字资产类型，资产实例具备唯一性，通过对非同质数字资产结构的优化可以使其更加灵活地服务于区块链网络游戏。

Cocos-BCX 重新设计了数据结构，增加了自定义数据存储，以容纳可能的游戏数据和扩展内容。同时也相应调整共识、见证、出块等关键流程，以匹配新的数据结构。BCX中的道具数据，只在生成和属性变动时在块数据中作完整记录，普通的事务和流转时，则仅记录哈希指针，确保块数据的体积不会因长期的事务过快的增长。

Cocos-BCX 区块链中的非同质数字资产数据结构分为固有数据区域和扩展数据区域。其中固有数据区域存储非同质数字资产的基本信息，包括资产ID、世界观申明和基础数据区域。资产ID，即资产实例在分布式账本网络中的唯一标识，是该资产在被访问、查询、修改时的唯一凭据；世界观申明，包括世界观ID以及该资产生效和支持的游戏类型、世界，以及此资产在网络中流通需要使用的世界流通货币类型；基础数据区域，包括资产所有者、制作者、制作时间、资产基础属性如游戏道具强度等信息。

扩展数据区域支持非同质数字资产属性扩展，是该资产支持的世界观内游戏具体业务数据的存储区域，包括域数据和组合关系数据。不同的游戏或者其他业务实体在域数据拥有专属的域标识和数据区，并且数据区相互隔离，域数据以域标识和数据的键值对形式存储，代表该资产在具体游戏内的数据如攻击值、防御值、耐久度等；扩展数据区域配置组合关系数据，描述资产组合、嵌套和从属关系。

基于这一系列针对非同质数字资产的数据结构设计，产生了第一个通用可扩展非同质数字资产标准——BCX-NHAS-1808标准。

**资产与合约的数据分离**

同质、非同质资产和智能合约数据在链上的存储是分离的。

Cocos 的网络中会存在大量的、持续发生的事务，需要尽可能降低资产解析和流转的运算成本，资产与合约分离可以实现合约的单独解析执行以及必要结果上链的操作。

在资产与合约数据存储分离的设计下，资产拥有者具备该资产的全部权限，资产的操作仅能由拥有者的授权完成。可以避免因资产合约不分离而出现通过修改合约内容而破坏资产属性或者调用他人资产的情况发生，并且不考虑合约因素的制约则更容易实现非同质资产的跨链映射，因此资产和合约分离是更安全的设计。

**改进的共识机制**

Cocos-BCX 测试链的共识层采用DPoS共识算法。

DPoS 算法通过预定见证人和规定时间槽位来推测区块的生产者以及出块时间，通常时间槽位间隔为5秒，在实际使用过程中为了更快的网络广播速度以及更大的网络吞吐量而将时间槽位间隔设置为3秒，如果预定的见证人在规定的时间槽到来时，因为网络原因或者设备硬件故障没有正常的出块，则该时间槽位不会出块，网络将等待下一个时间槽位到来选择另一个预定见证人进行出块。

Cocos-BCX 中，所有的预定见证人都由所有的持股人从见证人中投票选举，预定见证人统称为活跃见证人，活跃见证人数量通常为11~101个。所有的活跃见证人在DPoS共识算法的见证人预定算法中具有相同的出块预定概率，这保证了所有见证人的出块概率和获取出块奖励是一致的。石墨烯投票更新时间通常为24小时，但出于安全性、稳定性、公平性的考虑，项目初期网络投票更新时间通常较短，可能为12小时甚至更短。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/56e6d50-1111.png",
        "1111.png",
        566,
        160,
        "#a2c5dc"
      ],
      "caption": "现存共识机制优劣势对比"
    }
  ]
}
[/block]
在 DPOS 算法中通过预定见证人和规定时间槽位来推测区块的生产者以及出块时间，主链的活跃见证人总是多于支链，故此主链区块高度一定高于支链，同时全网投票机制避免了见认证人集中化，保证了网络的安全性，不同见证机制之间的优劣对比如图所示。
[block:api-header]
{
  "title": "轻量级节点"
}
[/block]
在 Cocos-BCX 设计中，轻量级节点（下文简称为“轻节点”）本质上是一个具备与链互操作能力的环境，与全节点不同，轻节点不需要同步全网数据，取而代之的是同步运行必须的合约信息与环境数据，这样的设计可以大幅减少节点同步的数据量和同步时间，使链上游戏端软件具备了实际使用的容量、时间成本可行性。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/6ffb45d-1111.png",
        "1111.png",
        1345,
        518,
        "#313436"
      ]
    }
  ]
}
[/block]
Cocos-BCX 开发的游戏整体以合约形式在轻节点上本地化运行，但合约中标识出需要共识的部分将被单独拆分为一个或多个子合约发布至相关节点进行共识（详细介绍见文中 在语法级别支持共识任务），这样的设计能够让巨大的游戏合约以更具效率、几乎无延迟的方式运行，分别处理合约的共识与非共识部分也能够在尽可能保障用户体验的前提下保持与传统区块链一样，数据具有可靠性。同时，对于轻节点的验证也不再像传统区块链一样进行过程和结果的验证，而是对节点运行环境和输入数据的验证（可信执行环境验证），进一步提高了整体的运行效率。
[block:api-header]
{
  "title": "定时器和心跳"
}
[/block]
几乎所有的游戏与应用都需要实现在线检测，而在 Cocos-BCX 设计区块链游戏时，为了解决用户的状态检测与持续的会话机制，提出了定时器与心跳的概念。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/25091c4-33.png",
        "33.png",
        1225,
        618,
        "#2c383f"
      ]
    }
  ]
}
[/block]
在区块链网络中实现定时器首先需要实现时间同步机制，而传统的时间同步机制通常是由外部授时或信任中心实现的，而在区块链去信任的逻辑下，外部授时或信任中心都存在无法自证的缺陷，因此链上时间的同步只能由链内完成。

Cocos-BCX 提出的时间同步方案是：利用块数据时间戳，出块节点在发布块时即等效的进行了时间同步广播，各节点收到块广播后完成时间同步操作，最终全网在一个块同步周期中完成了一次时间同步过程。

基于这个设计，定时器能够顺理成章地实现：定时器以块周期为最小计时粒度，按照预先设定的计时目标工作。由于区块数据时间戳为标准时间计数，不存在时区等因素的偏差，可认为是全网统一的计时标准，计时器可以在任意网络区域、时区以同样的计时规则正常执行。

心跳与定时器相近，其心跳的时间脉冲同样来自于区块的时间戳，一个心跳周期中，节点/端会提交自己的连接更新信息，如果发现某一周期没有特定的端/节点更新信息，则证明这个端/节点掉线，定时器和心跳为用户状态检测和未来的会话机制提供了应用基础。
[block:api-header]
{
  "title": "高速合约虚拟机"
}
[/block]
Cocos-BCX 拥有足够的高并发处理能力。

目前的绝大部分联网游戏，当用户规模达到一定程度时，其服务器需要在短时间内进行大量的数据处理，而在现有的以太坊网络中是无法实现的。

Cocos-BCX 采用改进的 DPOS 共识，理论吞吐量约10万TPS，其高并发处理性能在合理的数据管理模式设计下足以支持现有游戏的开发与正常运行，基本满足大型联网游戏在平台中的运营诉求，保证用户的游戏体验与现有的中心化游戏几乎没有区别。

由于大规模网络游戏的数据交互频率非常高，DNF曾创下60万人同时在线的记录，Steam 游戏平台更有1420万人同时在线的惊人数据。如果每一个在线用户提交数据的行为都视为发起了一次共识申请，Cocos-BCX 的极限吞吐能力不足以支撑这样级别的处理请求，开发团队按见证速度的需求设计了不同的见证委托模式（Delegation Templates），使单一见证委托人不用对所有运行中的游戏作同时见证和处理，而是专注于对复数个同类型游戏作见证和计入区块的工作。并且，在这一模式下，不同游戏的数据提交/见证是相对异步的过程，每一个游戏会选择适合的委托模式，而异步模式下的数据验证则可以通过链上数据库服务来完成，即用户在链上验证并完成数据存取。这一过程非常高效，足够支撑大规模游戏场景下的玩家数据操作。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/1e104cd-1234.png",
        "1234.png",
        637,
        253,
        "#baddfb"
      ],
      "caption": "Cocos-BCX的合约"
    }
  ]
}
[/block]
合约是一段可以自动执行的程序，同时作为系统参与者，按照环境的基本规则（编译器规则）执行预设的任务，合约可以定义输入和输出，能够接受和存储价值，同时向外发送信息和价值。智能合约是以“不信任原则”为前提设计的，每一个节点均认为彼此不可信任。由于区块链的分布式保存特性，链上的每一个节点均保存有同样的合约执行代码，合约的运行结果由全网算力共同见证，并通过全体表决形式决定运算结果是否被认可。Cocos-BCX 的合约支持见证委托的定义。
为了保障合约执行的效率足以向用户提供足够良好的游戏体验，Cocos-BCX 重新设计了一套针对链上游戏场景的基于LUA的高速合约虚拟机方案。不同于现有区块链的合约虚拟机方案，除了通过大幅定制和优化现有的区块链运行环境及合约虚拟机的执行效率外，Cocos-BCX 的虚拟机使用与游戏SDK相同的语言和API系统，并提供链和游戏执行环境的互操作接口，这将彻底改变区块链合约环境单一、灵活性差、定制能力差的现状。智能合约的应用场景将不再限于作为货币描述，而是开始能够接纳更多与游戏直接相关的内容，包括可能的诸如：基础规则、设定、单位、场景、甚至地图等。改进后的虚拟机不仅支持更为复杂和灵活的合约形态，并且将大幅度提高现有智能合约的运行效率。