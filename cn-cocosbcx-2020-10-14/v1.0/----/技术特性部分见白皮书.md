---
title: "技术特性"
slug: "技术特性部分见白皮书"
hidden: false
createdAt: "2018-12-14T09:20:41.592Z"
updatedAt: "2018-12-17T06:51:55.039Z"
---
[block:api-header]
{
  "title": "链内的可信随机过程"
}
[/block]
区块链游戏规则上链能否具有实际应用价值与能否在链上实现随机过程密切相关。通过研究发现，完整的链上随机过程需要解决一个关键问题：链上随机过程规则由智能合约描述，而合约的过程是公开的，若需要产生无法被第三方推算的随机结果，则需要合约运行时有节点的噪声参与这一过程的输入，但不同节点的噪声不可能一致，即其他节点无法通过再次运行这份合约来验证这次随机过程的结果是否正确，最终导致无法完成共识。
**要解决这个问题，我们提出了三种可实施的方案：**

**方案一**
在区块链动态数据区维护一个或若干随机数据池，出块人将随机过程的结果包裹在区块的加密数据段中并且加密过程的代码以闭源、不公开的形式发布。此时，所有节点将拥有同一套随机数据池。随机数据池的数据结构呈管道形态，具有读端和写端的封装，且仅允许符合规则的读写端访问，具有先进先出的特性。
因为区块链的所有节点事务处理具有一致性，应用在申请随机过程结果时可从随机数据池中读取。在该随机过程产生、分配机制下，过程与结果的安全性能够满足区块链网络对随机过程的安全性需求：
	因为区块链的所有节点事务处理具有一致性，应用在申请随机过程结果时可从随机数据池中读取。在该随机过程产生、分配机制下，过程与结果的安全性能够满足区块链网络对随机过程的安全性需求：
	任意一种访问（读、写）行为都将导致随机数据池发生变化且无法复原；
	写入随机数据的行为由动态加密函数库完成，且函数库闭源、不公开；
	随机数据的生产者无法获知此次随机过程的结果将放入随机数据池的位置以及这一随机过程将会被谁使用；
这一随机过程的实现方案适用于链网络对事务处理顺序具有一致性的场景，例如RPG游戏中玩家开启地图宝箱获取随机道具的过程。

**方案二**
通过委托机制，允许部分事务委托至某可信节点簇完成处理，节点簇中随机分配当前在线的可信节点执行事务，可信节点完成处理后记录随机过程结果，并由通知或轮询机制让委托方获取结果。
因为该方案基于链事务委托机制，对链的改动会小于方案一，但要保证方案的可行性，应满足以下需求：
	受托方应通过可信执行环境验证，确保自身可信；
	受托方运行随机过程并发布结果时，应采用同样具备安全性的加密函数库完成；
	加密数据的传递需通过“零知识证明”或其他可靠证明方案证明受托方身份并能够被委托方识别，确保委托方得到的数据不是由第三方伪造。
此随机过程实现方案适用于事务具有多方参与但仅需要同一批随机结果的应用场景，例如棋牌游戏中每一局的洗牌顺序等。

**方案三**
当前的区块生产者接收到随机事务，通过随机函数生成一个随机结果并将随机过程与随机结果通过加密函数加密写入区块数据，并打包发送到全网，其余普通节点接受该随机结果并应用，以此完成随机事务的共识。
这一随机过程的实现方案已经完成，适用于游戏中的抽奖场景等，如掷骰子产生一个随机结果。
[block:api-header]
{
  "title": "合约的持续执行"
}
[/block]
通过轻节点的方式，游戏整体作为一个合约运行的设想得到了实现可能，本地运行的游戏合约
能够长期、持续地在轻节点中运行这一过程与出块周期或块大小都无关，与之相关的仅是游戏合约
中包含共识的子合约内容。

游戏合约与子合约根据语法级别的共识优先级标识，分别选择以异步共识和同步共识的方式，
在持续运行的同时也不断完成关键步骤的验证和同步，实现了游戏合约持续运行以及结果共识见证
的机制。
[block:api-header]
{
  "title": "合约会话机制"
}
[/block]
链上提供会话建立接口，该接口在合约公共数据区建立一个具有有效限制的用户会话列表，会
话区间的用户将有权限向同会话区间的其他用户推送事务，其他用户收到数据变动通知时，可及时
获取对应数据。
[block:api-header]
{
  "title": "合约的共识优先级"
}
[/block]
传统区块链的事务执行确认是在节点接收到区块数据，完成事务内容解析，运行并得到正确结果验证通过写入块数据时确认的，当一个事务被提交时这个事务实际进入了pending队列，而此时事务仍并未执行，直到下一个出块周期，这样的机制导致事务始终无法更及时地得到响应和处理。

**优先级共识**
Cocos-BCX在语法级别对事务增加了优先级标识的设计，当事务被标记为立即确认时节点会在第一时间完成事务提交、处理、广播，而区块生成与事务执行过程变成了相互异步的操作，达到事务的快速异步确认；即时响应为另一种共识优先级，在这种模式下事务的响应却几乎是没有延迟的，节点会在第一时间完成事务提交，大幅提高了事务的响应速度。

**分区见证**
为了进一步提高节点利用率和处理效率，Cocos-BCX在委托见证的基础上提出了分区见证的设计，即某些节点专注处理特定类型的合约请求，其原理如图

[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/5e29e0e-121212.png",
        "121212.png",
        633,
        280,
        "#f4f4f4"
      ],
      "caption": "合约的分区见证机制"
    }
  ]
}
[/block]
分区见证在游戏行业应用的意义在于能够针对不同请求类型针对性优化相关节点的处理能力，例如对浮点运算集中型请求重点加强核心算力，对结构数据处理集中型请求重点加强存储IO能力等，最终达到整体的效率、效益最优配置。

**极小延迟的事务响应**
Cocos-BCX设计链上处理所有游戏中需要共识的事务，其中不乏要求高速响应和即时确认的部分，而传统区块链的事务响应取决于出块行为，而最快确认速度也受限于出块周期限制，难以满足游戏合约对事务即时确认的需求。
**事务的快速异步确认**
合约支持语法级别的共识标记，合约运行时，被标记为立即确认的事务将被抽出并立即广播，当任意节点收到后会立即运行该过程得到结果并广播运行结果，同时本周期的出块人将把广播的结果存入结果池，当相同的结果数量达到判定通过的阈值时，出块人立即广播事务确认的结果并将此事务写入出块缓存，整体流程如图

[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/f2ff018-2323.png",
        "2323.png",
        338,
        452,
        "#eaf0f4"
      ],
      "caption": "异步共识下数据处理示意图"
    }
  ]
}
[/block]
在这个设计下，节点会在第一时间完成事务提交、处理、广播，而区块生成与事务执行过程变成了相互异步的操作，达到事务的快速异步确认。

**即时响应**
Cocos-BCX设计中，优先级标记为即时响应合约时，当用户向节点发出事务请求，节点将立即向网络发出事务广播，并同时向用户返回事务hash值。在这个设计下，其实事务最终记录周期与传统设计并没有太大差异，但事务的响应却几乎是没有延迟的，节点会在第一时间完成事务提交，大幅提高了事务的响应速度。
进一步的，用户可通过事务hash值跟踪事务状态，同时事务信息将更新到用户历史事务数据表中动态向用户推送，用户不必等待事务在链网络中验证、应用之后的回调再响应。我们借鉴了以太坊的hash跟踪特性，并在此之上加入了用户事务动态推送的机制。

[block:api-header]
{
  "title": "在语法级别支持共识任务"
}
[/block]
Cocos-BCX提出了让合约在语法级别支持共识任务的设计，通过特定的关键词修饰脚本的共识优先级，使合约解释器能够识别并在运行全文扫描时将有标记的需要共识的合约部分拆分出形成子合约发送至链网络的相关节点进行共识，共识优先级别从低到高包括不需共识、正常共识、即时响应、立即确认等。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/cd8de86-1.png",
        "1.png",
        492,
        454,
        "#e9eef3"
      ],
      "caption": "轻节点与合约拆分运行原理"
    }
  ]
}
[/block]
合约整体在本地执行，到达需要共识的部分时，根据语法级别的优先级标识来确认共识方法，不同优先级采用不同的共识步骤，游戏合约的运行更加流畅，使可能发生的阻塞等待更低、时间更短。被标记为优先级最高的立即确认的合约主体的运行过程与共识过程是两个相对独立的异步过程；被标记为即时响应的合约部分，事务在提交的同时，节点会立即回复信息被提交的回执，即事务hash值(Tx ID)；正常共识的合约事务则按区块链事务执行的正常流程被执行；被标记为不需共识的合约内容仅在轻节点上运行。
此外，需要被共识的合约部分是拆分后以子合约方式分发执行的，这些子合约内容应该具备完整的上下文关系和无额外依赖的设计，以便在其他节点上也能正确的得到结果。

[block:api-header]
{
  "title": "事务委托机制"
}
[/block]
委托型事务主要用于处理随机性高，不同节点执行会产生不同结果的事务类型（如产生一组随机数），但此类型事务仅限于非个人数据关联的事务请求。合约中的共识标记允许定义需要委托参与共识的节点簇 （节点组） 名称，指明事务需要由哪一类节点处理。当数量只有一件时（N=1），被指名的节点簇会随机选择簇内一个当前在线的节点分配处理该事务，例如处理随机事件；当委托节点数量大于一件（N>1）或为一个簇时，被指名的簇内的多个节点将被分配至处理该事务。通过可信执行环境认证的受托人收到委托事务之后，会验证事务的可行性并执行委托，完成后将事务结果加密并打包向链上广播。
指定委托节点簇名的设计出发点有两个：一是出于安全性的考虑，只指定委托节点簇名，簇内随机选择节点处理事务，委托方不知道所委托的具体节点，这样可很好地防止作弊；二是从运行可靠性出发，指名节点簇可保证簇里分配事务到当前在线的节点。
在此机制下，链内的随机过程成为了可能，用户可以委托可信节点生成一个随机数、委托可信节点维护合约公共数据等。进一步的，合约的开发者可以在此机制上可实现合约内部的函数回调机制。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/74b96fe-12.png",
        "12.png",
        449,
        351,
        "#f6f5f6"
      ],
      "caption": "基于委托的分区共识"
    }
  ]
}
[/block]

[block:api-header]
{
  "title": "游戏数字资产的映射"
}
[/block]
同质数字资产的映射
游戏数字资产与以太坊ERC20数字资产映射如下图所示：
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/693676c-13.png",
        "13.png",
        581,
        132,
        "#efefef"
      ],
      "caption": "ERC20数字资产映射关系"
    }
  ]
}
[/block]
游戏金币支持通过映射网关与其他联盟链以及独立链进行资产转移。

非同质数字资产的映射
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/2460075-14.png",
        "14.png",
        603,
        128,
        "#eaeaea"
      ],
      "caption": "Cocos-BCX与ERC721数字资产映射关系"
    }
  ]
}
[/block]
BCX-NHAS-1808是COCOS应用中适用于去中心分布记账式网络的非同质数字资产标准，具备资产与合约分离的特性以及可扩展、可自定义的数据区域，可兼容其他非同质资产标准。
ERC875 和ERC721数字资产标准都是以太坊针对非同质数字资产的标准协议。在某种程度上，ERC875 更像是ERC721 的“简略缩水”升级版。ERC721创建了非同质数字资产的标准先河，其随后更新的ERC841 和ERC821 都是在其上某部分进行的优化修改；而ERC875标准则更加简单直接。其定义的函数包括name 、symbol、balanceOf、transfer、transferFrom，totalSupply、ownerOf、trade。对比ERC721标准，ERC875的函数更加简单。
通过进一步扩展承兑网关支持的数字资产技术，网关将能够在未来支持以ERC721、ERC875为代表的非同质复合型合约，承兑网关对游戏道具与非同质合约的承兑类似于一个专用编译器，通过对结构化数据的翻译和转换，实现非同质合约到链内游戏道具的双向承兑，兼容更多类型的链内外道具流转，提供更丰富的游戏内容和用户体验。
[block:api-header]
{
  "title": "操作的原子合并"
}
[/block]
区块链游戏的道具制作是原子性的，道具制作者根据玩家提交的需求和材料、资产打造道具，打造完成后，道具转移给玩家。在这一过程中包含一系列操作(OP)：数字资产生成、设置道具属性、变更资产所有权到用户等，为了保证过程中所有操作结果的一致性，我们将这一系列操作合并为了一个事务，即一次原子操作，事务中的所有操作只会同时成功或同时失败。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/cf33625-1212.png",
        "1212.png",
        511,
        328,
        "#d4d8dd"
      ],
      "caption": "多操作原子合并"
    }
  ]
}
[/block]
原子合并的另一个应用是Project BCX的去中介资产流转，目的是让卖家多获益、买家少消耗。去中介流通平台本身不存储用户的资产数据，而仅作为点对点请求的撮合媒介，游戏厂商可以灵活的设计自己的游戏资产数据结构，可流转的内容不局限于游戏内的同质资产，也涵盖道具、装备、游戏数据等非同质资产。用户在游戏内容流通平台上提交出让请求时，请求对应的游戏资产（金币或道具等）将被锁定，暂时无法继续在游戏中使用，直到取消本次请求。请求包含出让人的主链ID以及出让资产的内容，当出让请求达成时，系统自动完成资产所有权的变更，并且向出让人转移购入请求人支付的资产，完成整个流转请求。
发生资产流转行为时，出让/求购以请求的形式提交至流通平台，资产转移与资产的所有权变更被视为一次不可分割的操作，即双方的行为均需被共识认可，如果任意一方资产变更动作不被主链区块认可，则整个事务将被回滚。即在整个流转过程中资产的所有权变更或资产转移等行为将打包在一笔事务内，两个动作的状态具有一致性，事务正常完成后将产生唯一链上可查的事务ID。
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/5d2d799-1313.png",
        "1313.png",
        575,
        191,
        "#dbe4f0"
      ],
      "caption": "原子事务状态判定机制"
    }
  ]
}
[/block]

[block:api-header]
{
  "title": "防止BP/开发者作弊机制"
}
[/block]
BP作为全网的事务处理与通信核心，能够先于一般节点获知最近事务的处理结果，因此对于某些具备时效性或机密性的信息，BP拥有较一般节点更高的优先权，因此具备了从信息获取方面作弊的可能，例如提前获知一个随机过程的结果并利用合约提前预测运行结果等，这对链上的游戏无疑是不公正的，也是不安全的。

开发者在这里包括链网络的底层开发者以及合约开发者等一切有能力进行一定程度链交互/改造能力的个人或组织，开发者具备深度解析/控制链内信息的能力，并且有理由相信开发者能够通过阅读代码等方式获知传输过程中可能会使用的加密/隐蔽通信技术细节从而使之能够针对性的设计代码从而以非法方式获知这部分信息(随机过程、敏感信息数据等)。

因此BCX方案中设计了一套针对BP和开发者可能作弊环节的事务执行、消息传递、运行机制，将在下文中简要介绍。

**动态加密传输**

为防止敏感信息在广播传输过程中被监听并解析，BCX链网络通信针对这类信息增加了使用动态加密的安全通信方式，如图：
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/d98375e-11111.png",
        "11111.png",
        639,
        180,
        "#f4f5f6"
      ],
      "caption": "动态加密传输机制"
    }
  ]
}
[/block]
以随机种子的产生为例，当一个随机种子被产生后，生产者将把一段与时间、块高度、其他噪声输入等相关的动态数据作为AES密钥加密这段随机种子信息并广播加密后的信息。由于所有的节点拥有同样的动态密钥生成算法，因而可以正确的解出种子信息，而非法窃听的第三方无法解出，保证了敏感信息在传输过程中的安全性。

**防止自定义节点接入网络**

保证信息的传输安全并不能防止节点开发者通过修改程序来达到输出收到并解密后的信息，因此本方案中设计了一套身份验证机制用以防止修改后的节点程序接入链网络，如图
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/c39b973-55.png",
        "55.png",
        574,
        267,
        "#f5f6f7"
      ],
      "caption": "节点接入验证机制"
    }
  ]
}
[/block]
BCX节点程序将在发布时内嵌一个不包含在公开源代码中且与版本号关联的验证信息，当节点试图连接链网络和其他节点时，其他节点将会验证这一信息是否与链网络中记录的校验信息一致，并会主动拒绝无法通过验证的节点连接，防止修改后的节点程序连入链网络进行恶意行为。同时二次开发者也可以通过自定义源代码中的这一身份验证信息，发布属于自己的链网络，并将同样具备防止非官方节点接入的特性。

**隐藏过程变量**

由于合约自身是一套图灵完备的状态机系统，因此固定的输入一定会得到固定的输出，并且在事务机制下将结果广播至全网同步，而如果广播的信息是一系列行为的中间过程，则可能导致一些不适宜被获知的过程变量被公开。因此本方案针对这类情况，提出了使用隐藏过程变量的合约执行逻辑，如图
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/f51a52e-222.png",
        "222.png",
        559,
        416,
        "#f9f9fa"
      ],
      "caption": "过程变量隐藏机制"
    }
  ]
}
[/block]
通过合理的合约设计，将涉及敏感数据的过程变量放在同一个操作(OP)过程中执行，由于执行过程在执行节点内存中完成，最终广播的是操作结果，因此过程变量在整个周期中是被隐藏的，不会存在暴露的风险。

**带有执行身份验证的合约机制**

为了防止恶意的开发者通过测试性调用合约接口来预测合约的可能输出，本方案的合约系统中增加了执行身份验证机制，即合约特定的接口需要具备授权的账户才能够执行，如图
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/9e9dcfa-3333.png",
        "3333.png",
        633,
        258,
        "#f8f8f8"
      ],
      "caption": "带有执行身份验证的合约机制"
    }
  ]
}
[/block]
当合约收到执行请求时，会验证请求信息中的签名信息，与合约中规定的执行者权限验证，验证通过的执行者请求才会正常执行合约函数，否则合约将直接结束，并且不会返还请求者支付的费用，在这套机制下， 即便开发者知道链与合约的代码，了解执行过程和原理，也无法恶意调用特定的接口，保证了合约无法被随意调用推测其执行结果。

**敏感过程通过内部可信环境执行**

对于在一定时间内持续敏感的信息或操作过程(例如一场牌局)，本方案允许阶段内的执行逻辑在TEE(Trusted Execution Environment, 可信执行环境)机制保障下以黑盒模式运行，平时链网络通过TEE保障机制对这些黑盒环境发起周期性的挑战/验证以保证环境的可信，并在需要执行持续性敏感过程时随机选择一个其中一个环境运行，过程执行完成后将向链上提交足以回溯执行过程的记录信息与结果信息，以保证链网络上记事的公正、公开、透明。其原理如图：
[block:image]
{
  "images": [
    {
      "image": [
        "https://files.readme.io/e4172d7-444.png",
        "444.png",
        643,
        175,
        "#f3f3f5"
      ],
      "caption": "敏感过程内部执行机制"
    }
  ]
}
[/block]
在这一机制的保障下，开发者与BP均无法参与黑盒过程的执行，因此可以有效的避免两者从中作弊的可能，结合上述各个保障设计，可以让 Cocos-BCX 以可信、可靠、安全的执行环境运行所有支持的业务过程。